{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Submit Price" %} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .searchable-select-wrapper {
        position: relative;
    }
    
    .select-search-input {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        background-color: white;
        font-size: 0.875rem;
        line-height: 1.25rem;
    }
    
    .select-search-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
        border-color: #10b981;
    }
    
    .select-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 50;
        display: none;
    }
    
    .select-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        font-size: 0.875rem;
    }
    
    .select-option:hover {
        background-color: #f3f4f6;
    }
    
    .select-option.selected {
        background-color: #dbeafe;
        color: #1d4ed8;
        font-weight: 500;
    }
    
    .select-option:last-child {
        border-bottom: none;
    }
    
    .no-results {
        padding: 0.75rem;
        text-align: center;
        color: #6b7280;
        font-style: italic;
    }
    
    .hidden {
        display: none !important;
    }
    
    .form-select, .form-input, .form-textarea {
        width: 100%;
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }
    
    .form-select:focus, .form-input:focus, .form-textarea:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .form-textarea {
        resize: vertical;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">{% trans "Submit Price" %}</h1>
                    <p class="text-gray-600 mt-1">{% trans "Submit today's prices for your products" %}</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">{% trans "Today's Date" %}</div>
                    <div class="font-medium text-gray-900">{{ today|date:"F j, Y" }}</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Price Submission Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">{% trans "Add New Price" %}</h2>
                    
                    <form method="post" class="space-y-6">
                        {% csrf_token %}
                        
                        <!-- SKU Selection -->
                        <div>
                            <label for="sku-search" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.sku.label }}
                            </label>
                            <div class="searchable-select-wrapper">
                                <input type="text" 
                                       id="sku-search" 
                                       class="select-search-input" 
                                       placeholder="Search for a product..."
                                       autocomplete="off">
                                <div id="sku-dropdown" class="select-dropdown">
                                    <!-- Options will be populated by JavaScript -->
                                </div>
                                <!-- Hidden input to store the selected value -->
                                <input type="hidden" name="sku" id="id_sku" value="">
                            </div>
                            {% if form.sku.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.sku.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-1 text-sm text-gray-500">Start typing to search for products</p>
                        </div>

                        <!-- Price -->
                        <div>
                            <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.price.label }}
                            </label>
                            {{ form.price }}
                            {% if form.price.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.price.errors.0 }}</p>
                            {% endif %}
                            {% if form.price.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.price.help_text }}</p>
                            {% endif %}
                        </div>

                        <!-- Quantity Available -->
                        <div>
                            <label for="{{ form.quantity_available.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.quantity_available.label }}
                            </label>
                            {{ form.quantity_available }}
                            {% if form.quantity_available.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.quantity_available.errors.0 }}</p>
                            {% endif %}
                            {% if form.quantity_available.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.quantity_available.help_text }}</p>
                            {% endif %}
                        </div>

                        <!-- Submission Method -->
                        <div>
                            <label for="{{ form.submitted_via.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.submitted_via.label }}
                            </label>
                            {{ form.submitted_via }}
                            {% if form.submitted_via.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.submitted_via.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Notes -->
                        <div>
                            <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                {{ form.notes.label }}
                            </label>
                            {{ form.notes }}
                            {% if form.notes.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
                            {% endif %}
                            {% if form.notes.help_text %}
                                <p class="mt-1 text-sm text-gray-500">{{ form.notes.help_text }}</p>
                            {% endif %}
                        </div>

                        <!-- Submit Button -->
                        <div class="flex items-center justify-between">
                            <a href="{% url 'core:dashboard' %}" class="text-gray-600 hover:text-gray-800">
                                ← {% trans "Back to Dashboard" %}
                            </a>
                            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                {% trans "Submit Price" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Today's Submissions -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">{% trans "Today's Submissions" %}</h3>
                    {% if today_prices %}
                        <div class="space-y-3">
                            {% for price in today_prices %}
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <div class="font-medium text-gray-900">{{ price.sku.name }}</div>
                                    <div class="text-sm text-gray-600">₹{{ price.price }}</div>
                                </div>
                                <div class="text-xs text-gray-500">
                                    {{ price.submitted_at|time:"H:i" }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-gray-500 text-sm">{% trans "No prices submitted today" %}</p>
                    {% endif %}
                </div>

                <!-- Quick Tips -->
                <div class="bg-blue-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-blue-900 mb-4">{% trans "Quick Tips" %}</h3>
                    <ul class="space-y-2 text-sm text-blue-800">
                        <li class="flex items-start">
                            <span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                            {% trans "Submit prices early in the day for better visibility" %}
                        </li>
                        <li class="flex items-start">
                            <span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                            {% trans "Check market rates before setting your price" %}
                        </li>
                        <li class="flex items-start">
                            <span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                            {% trans "Update quantity available based on actual stock" %}
                        </li>
                        <li class="flex items-start">
                            <span class="inline-block w-2 h-2 bg-blue-600 rounded-full mt-2 mr-2 flex-shrink-0"></span>
                            {% trans "Add notes for quality specifications" %}
                        </li>
                    </ul>
                </div>

                <!-- Market Summary -->
                <div class="bg-green-50 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-green-900 mb-4">{% trans "Market Summary" %}</h3>
                    <div class="text-sm text-green-800">
                        <div class="flex justify-between mb-2">
                            <span>{% trans "Active Farmers:" %}</span>
                            <span class="font-medium">{{ market_stats.active_farmers|default:"--" }}</span>
                        </div>
                        <div class="flex justify-between mb-2">
                            <span>{% trans "Today's Submissions:" %}</span>
                            <span class="font-medium">{{ market_stats.today_submissions|default:"--" }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>{% trans "Available Products:" %}</span>
                            <span class="font-medium">{{ market_stats.available_skus|default:"--" }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // SKU data from Django context
    const skuData = [
        {% for sku in form.sku.field.queryset %}
        {
            id: {{ sku.id }},
            name: "{{ sku.name|escapejs }}",
            category: "{{ sku.category.name|escapejs }}",
            unit: "{{ sku.unit|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const searchInput = document.getElementById('sku-search');
    const dropdown = document.getElementById('sku-dropdown');
    const hiddenInput = document.getElementById('id_sku');
    
    let selectedIndex = -1;
    let filteredOptions = [];
    
    function renderOptions(options) {
        dropdown.innerHTML = '';
        filteredOptions = options;
        
        if (options.length === 0) {
            dropdown.innerHTML = '<div class="no-results">No products found</div>';
        } else {
            options.forEach((sku, index) => {
                const option = document.createElement('div');
                option.className = 'select-option';
                option.innerHTML = `
                    <div class="font-medium">${sku.name}</div>
                    <div class="text-xs text-gray-500">${sku.category} • ${sku.unit}</div>
                `;
                option.addEventListener('click', () => selectOption(sku, index));
                dropdown.appendChild(option);
            });
        }
    }
    
    function selectOption(sku, index) {
        searchInput.value = sku.name;
        hiddenInput.value = sku.id;
        dropdown.style.display = 'none';
        selectedIndex = index;
        
        // Remove selected class from all options
        dropdown.querySelectorAll('.select-option').forEach(opt => opt.classList.remove('selected'));
        // Add selected class to current option
        if (dropdown.children[index]) {
            dropdown.children[index].classList.add('selected');
        }
    }
    
    function filterOptions(query) {
        if (!query.trim()) {
            return skuData;
        }
        
        return skuData.filter(sku => 
            sku.name.toLowerCase().includes(query.toLowerCase()) ||
            sku.category.toLowerCase().includes(query.toLowerCase())
        );
    }
    
    // Event listeners
    searchInput.addEventListener('input', function() {
        const query = this.value;
        const filtered = filterOptions(query);
        renderOptions(filtered);
        dropdown.style.display = filtered.length > 0 || query.trim() ? 'block' : 'none';
        selectedIndex = -1;
        
        // Clear hidden input if search doesn't match exactly
        const exactMatch = filtered.find(sku => sku.name.toLowerCase() === query.toLowerCase());
        hiddenInput.value = exactMatch ? exactMatch.id : '';
    });
    
    searchInput.addEventListener('focus', function() {
        const filtered = filterOptions(this.value);
        renderOptions(filtered);
        if (filtered.length > 0) {
            dropdown.style.display = 'block';
        }
    });
    
    searchInput.addEventListener('keydown', function(e) {
        const options = dropdown.querySelectorAll('.select-option');
        
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, options.length - 1);
            updateSelection();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelection();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && filteredOptions[selectedIndex]) {
                selectOption(filteredOptions[selectedIndex], selectedIndex);
            }
        } else if (e.key === 'Escape') {
            dropdown.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    function updateSelection() {
        const options = dropdown.querySelectorAll('.select-option');
        options.forEach((opt, index) => {
            opt.classList.toggle('selected', index === selectedIndex);
        });
    }
    
    // Click outside to close
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
            selectedIndex = -1;
        }
    });
    
    // Initialize with all options
    renderOptions(skuData);
});
</script>
{% endblock %}
